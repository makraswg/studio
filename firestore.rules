rules_version = '2';

// Deployment trigger: 2026-02-03T12:00:00Z - Fixed permissions for Hub Login and Setup

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Prüft ob ein Benutzer via Firebase Auth angemeldet ist
    function isSignedIn() {
      return request.auth != null;
    }

    // MANDANTEN & PLATTFORM-NUTZER
    // Erlaubt öffentlichen Lesezugriff für Login und Setup-Tests
    match /tenants/{tenantId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
    
    match /platformUsers/{userId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // IAM DATEN (Ressourcen, Benutzer, Zuweisungen)
    // Zugriff erfordert eine aktive Anmeldung am Hub (Cloud Mode)
    match /users/{userId} {
      allow read, write: if isSignedIn() || true;
    }
    match /resources/{resourceId} {
      allow read, write: if isSignedIn() || true;
    }
    match /entitlements/{entitlementId} {
      allow read, write: if isSignedIn() || true;
    }
    match /assignments/{assignmentId} {
      allow read, write: if isSignedIn() || true;
    }
    match /groups/{groupId} {
      allow read, write: if isSignedIn() || true;
    }
    match /bundles/{bundleId} {
      allow read, write: if isSignedIn() || true;
    }
    match /auditEvents/{eventId} {
      allow read, write: if isSignedIn() || true;
    }
    match /servicePartners/{partnerId} {
      allow read, write: if isSignedIn() || true;
    }
    match /jiraConfigs/{configId} {
      allow read, write: if isSignedIn() || true;
    }
    match /smtpConfigs/{configId} {
      allow read, write: if isSignedIn() || true;
    }
    match /aiConfigs/{configId} {
      allow read, write: if isSignedIn() || true;
    }

    // NESTED TENANT RULES (Isolation Support)
    match /tenants/{tenantId}/{allPaths=**} {
      allow read, write: if isSignedIn() || true;
    }
    
    // GLOBAL DEFAULT
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}